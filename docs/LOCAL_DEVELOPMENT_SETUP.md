# Local Development Setup Guide

This guide walks you through setting up a complete local development environment for the Seattle Family Activities platform using AWS SAM CLI and CDK integration.

## Overview

The local development setup allows you to:
- Run backend Lambda functions as HTTP servers locally
- Connect the frontend to the local backend
- Use real AWS services (DynamoDB) with local credentials
- Test the complete application stack without deploying to AWS

## Architecture

```
┌─────────────────┐    HTTP     ┌─────────────────┐    AWS SDK    ┌─────────────────┐
│   Frontend      │────────────▶│   AWS SAM CLI   │──────────────▶│   Remote AWS    │
│ (localhost:8000)│             │  Local API GW   │               │   Services      │
└─────────────────┘             │ (127.0.0.1:3000)│               └─────────────────┘
                                └─────────────────┘                         │
                                         │                                  │
                                    ┌────▼────┐                      ┌─────▼─────┐
                                    │ Lambda  │                      │ DynamoDB  │
                                    │Functions│                      │ FireCrawl │
                                    │(Local)  │                      │  OpenAI   │
                                    └─────────┘                      └───────────┘
```

## Prerequisites

### Required Software

1. **Go 1.22.5+**
   ```bash
   # Check version
   go version
   
   # Install if needed (macOS)
   brew install go
   ```

2. **AWS CLI**
   ```bash
   # Check version
   aws --version
   
   # Install if needed (macOS)
   brew install awscli
   ```

3. **AWS SAM CLI**
   ```bash
   # Check version
   sam --version
   
   # Install if needed (macOS)
   brew install aws-sam-cli
   ```

4. **Node.js and npm** (for CDK)
   ```bash
   # Check versions
   node --version
   npm --version
   
   # Install if needed (macOS)
   brew install node
   ```

5. **Python 3** (for frontend server)
   ```bash
   # Check version
   python3 --version
   
   # Usually pre-installed on macOS
   ```

6. **direnv** (recommended for environment variables)
   ```bash
   # Install
   brew install direnv
   
   # Add to shell (add to ~/.zshrc or ~/.bashrc)
   eval "$(direnv hook zsh)"
   ```

### AWS Configuration

1. **Configure AWS credentials**
   ```bash
   aws configure
   ```
   
   Or use AWS profiles:
   ```bash
   export AWS_PROFILE=your-profile-name
   ```

2. **Verify AWS access**
   ```bash
   aws sts get-caller-identity
   ```

### Environment Variables

1. **Create `.envrc` file in project root**
   ```bash
   # .envrc
   export FIRECRAWL_API_KEY="your_firecrawl_api_key_here"
   export OPENAI_API_KEY="your_openai_api_key_here"
   export AWS_REGION="us-west-2"
   ```

2. **Allow direnv to load variables**
   ```bash
   direnv allow
   ```

## Setup Process

### Step 1: Install Dependencies

1. **Install CDK dependencies**
   ```bash
   cd infrastructure
   npm install
   ```

2. **Install Go dependencies**
   ```bash
   cd ../backend
   go mod tidy
   ```

### Step 2: Synthesize CDK Stack

The SAM CLI needs a CloudFormation template generated by CDK:

```bash
cd infrastructure
cdk synth
```

This creates the template at `infrastructure/cdk.out/SeattleFamilyActivitiesMVPStack.template.json`

### Step 3: Start Local Development

You have two options for starting the development environment:

#### Option A: Start Backend and Frontend Separately

1. **Start the backend** (in one terminal):
   ```bash
   cd backend
   ./start-local-backend.sh
   ```

2. **Start the frontend** (in another terminal):
   ```bash
   # From project root
   ./start-local-frontend.sh
   ```

#### Option B: Start Both Together

```bash
cd backend
./start-local-servers.sh
```

### Step 4: Verify Setup

1. **Check backend is running**
   ```bash
   curl http://127.0.0.1:3000/api/sources
   ```

2. **Check frontend is accessible**
   - Open http://localhost:8000 in your browser
   - Open http://localhost:8000/admin.html for admin interface

3. **Test API connectivity**
   - The frontend should automatically detect the local environment
   - Check browser console for any connection errors

## Development Workflow

### Making Backend Changes

1. **Edit Go code** in `backend/` directory
2. **Stop the backend server** (Ctrl+C)
3. **Restart the backend**:
   ```bash
   ./start-local-backend.sh
   ```

### Making Frontend Changes

1. **Edit files** in `app/` directory
2. **Refresh browser** - changes are immediately visible
3. **No restart needed** for HTML/CSS/JS changes

### Making Infrastructure Changes

1. **Edit CDK code** in `infrastructure/lib/`
2. **Re-synthesize the stack**:
   ```bash
   cd infrastructure
   cdk synth
   ```
3. **Restart backend server** to pick up new template

### Testing Changes

1. **Unit tests**:
   ```bash
   cd backend
   go test ./internal/models -v
   ```

2. **Integration tests**:
   ```bash
   cd backend
   ./scripts/run_integration_tests.sh
   ```

3. **Browser testing**:
   - Test main app functionality at http://localhost:8000
   - Test admin interface at http://localhost:8000/admin.html
   - Use browser developer tools to check API calls

## Environment Configuration

### Local Environment Variables

The backend uses these environment variables in local development:

```json
{
  "LOCAL_DEV": "true",
  "FAMILY_ACTIVITIES_TABLE": "seattle-family-activities-dev",
  "SOURCE_MANAGEMENT_TABLE": "seattle-source-management-dev", 
  "SCRAPING_OPERATIONS_TABLE": "seattle-scraping-operations-dev",
  "ADMIN_EVENTS_TABLE": "seattle-admin-events-dev",
  "AWS_REGION": "us-west-2",
  "FIRECRAWL_API_KEY": "your_key_here",
  "OPENAI_API_KEY": "your_key_here",
  "LOG_LEVEL": "DEBUG"
}
```

### Frontend Environment Detection

The frontend automatically detects local development:

```javascript
// Detects localhost and uses SAM local endpoints
const isLocal = window.location.hostname === 'localhost' || 
               window.location.hostname === '127.0.0.1';

if (isLocal) {
    config.apiEndpoint = 'http://127.0.0.1:3000/api';
}
```

## API Endpoints

When running locally, the following endpoints are available:

### Admin API (Port 3000)
- `GET /api/sources` - List all sources
- `POST /api/sources` - Create new source
- `PUT /api/sources/{id}` - Update source
- `DELETE /api/sources/{id}` - Delete source
- `POST /api/scrape` - Trigger scraping

### Public API (Port 3000)
- `GET /api/events` - List events
- `GET /api/events/{id}` - Get specific event

## Data Storage

### DynamoDB Tables

Local development uses separate table names with `-dev` suffix:
- `seattle-family-activities-dev`
- `seattle-source-management-dev`
- `seattle-scraping-operations-dev`
- `seattle-admin-events-dev`

### Data Isolation

- Local development uses different table names to avoid production conflicts
- Tables are created automatically when first accessed
- Data persists between local development sessions

## Next Steps

After setup is complete:

1. **Test the complete workflow**:
   - Add a source via admin interface
   - Trigger scraping
   - View results in main app

2. **Explore the codebase**:
   - Backend: `backend/internal/`
   - Frontend: `app/`
   - Infrastructure: `infrastructure/lib/`

3. **Run tests**:
   - Unit tests: `go test ./...`
   - Integration tests: `./scripts/run_integration_tests.sh`

4. **Make your first change**:
   - Try modifying the frontend UI
   - Add a new API endpoint
   - Update the data models

## Troubleshooting

See [TROUBLESHOOTING.md](TROUBLESHOOTING.md) for common issues and solutions.

## Browser Testing

See [BROWSER_TESTING.md](BROWSER_TESTING.md) for detailed browser testing procedures.